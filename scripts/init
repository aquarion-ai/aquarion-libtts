#!/usr/bin/env nu
# SPDX-FileCopyrightText: 2025-present Krys Lawrence <aquarion.5.krystopher@spamgourmet.org>
# SPDX-License-Identifier: AGPL-3.0-only

# Part of the aquarion-libtts library of the Aquarion AI project.
# Copyright (C) 2025-present Krys Lawrence <aquarion.5.krystopher@spamgourmet.org>
#
# This program is free software: you can redistribute it and/or modify it under the
# terms of the GNU Affero General Public License as published by the Free Software
# Foundation, version 3.
#
# This program is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
# PARTICULAR PURPOSE. See the GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License along with
# this program. If not, see <https://www.gnu.org/licenses/>.


# Initialize a fresh Devbox
#
# This installs Hatch and pre-commit in an isolated environments.
def "main" []: nothing -> string {
    install_tool hatch pip
    install_tool pre-commit
    install_tool commitizen cz-conventional-gitmoji
    install_tool babel
    install_tool reuse
    install_tool pip-licenses
    install_tool cyclonedx-bom

    pre-commit install --install-hooks
    lang extract
    lang compile
    nix-store --optimize
    nix-collect-garbage -d
}


### Internal commands

def get_python_version []: nothing -> string {
    open pyproject.toml | get project | get requires-python | str substring 2..
}

def get_tool_version [tool_name: string]: nothing -> string {
    (
        open pyproject.toml | get dependency-groups | get tools
        | find -n -r $"^($tool_name)\\W+=" | get 0
    )
}

def install_tool [tool_name: string, with_name?: string]: nothing -> string {
    let python_version = (get_python_version)
    let tool_version = (get_tool_version $tool_name)
    mut with_options = []
    if $with_name != null {
        let with_version = (get_tool_version $with_name)
        $with_options = ["--with", $with_version]
    }
    uv tool install -p $python_version --managed-python $tool_version ...$with_options
}
